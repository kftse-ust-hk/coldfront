{% extends "common/base.html" %}
{% load crispy_forms_tags %}
{% load common_tags %}
{% load static %}


{% block title %}
Allocation Review New and Pending Change Requests
{% endblock %}


{% block content %}
<div class="max-w-7xl mx-auto">
  <!-- Page Title -->
  <div class="mb-8">
    <h2 class="text-3xl font-bold text-primary-950">Allocation Change Requests</h2>
    <div class="mt-2 h-1 w-16 bg-secondary-500 rounded"></div>
  </div>

  <div class="bg-blue-50 border border-blue-200 rounded-lg p-6 mb-6">
    <p class="text-blue-700 text-justify"> 
      For each allocation change request below, there is the option to activate the allocation request and to view the allocation change's detail page.
      If a change request is only for an extension to the allocation, they can be approved on this page. However if the change request includes changes to
      the allocation's attributes, the request must be reviewed and acted upon in its detail page.
    </p>
  </div>

{% if allocation_change_list %}
  <div class="bg-white shadow-sm rounded-lg border border-gray-200">
    <div class="overflow-x-auto">
      <table class="min-w-full divide-y divide-gray-200">
        <thead class="bg-gray-50">
          <tr>
            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">#</th>
            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Requested</th>
            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Project Title</th>
            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">PI</th>
            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Resource</th>
            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Extension</th>
            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
          </tr>
        </thead>
        <tbody class="bg-white divide-y divide-gray-200">
          {% for change in allocation_change_list %}
            <tr class="hover:bg-gray-50 transition-colors duration-150">
              <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{{change.pk}}</td>
              <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{{ change.created|date:"M. d, Y" }}</td>
              <td class="px-6 py-4 text-sm text-gray-900">
                <a href="{% url 'project-detail' change.allocation.project.pk %}" class="text-primary-600 hover:text-primary-800 font-medium">
                  {{change.allocation.project.title|truncatechars:50}}
                </a>
              </td>
              <td class="px-6 py-4 text-sm text-gray-900">
                {{change.allocation.project.pi.first_name}} {{change.allocation.project.pi.last_name}}
                ({{change.allocation.project.pi.username}})
              </td>
              <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{{change.allocation.get_parent_resource}}</td>
              <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                {% if change.end_date_extension == 0 %}
                {% else %} {{change.end_date_extension}} days
                {% endif %}
              </td>
              <td class="px-6 py-4 whitespace-nowrap text-sm space-x-2">
                  <form method="post" action="{% url 'allocation-change-detail' change.pk %}" class="inline-flex gap-2">
                {% if change.allocationattributechangerequest_set.all %}
                  <button class="inline-flex items-center px-3 py-1.5 bg-gray-300 text-gray-500 text-sm rounded-md cursor-not-allowed opacity-60" 
                          aria-disabled="true" 
                          disabled>
                    Approve
                  </button>
                {% else %}
                    {% csrf_token %}
                    <input type="hidden" name="end_date_extension" value="{{ change.end_date_extension }}" />
                    <button type="submit" name="action" value="approve" class="inline-flex items-center px-3 py-1.5 bg-green-600 text-white text-sm rounded-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition-colors duration-200">
                      Approve
                    </button>
                {% endif %}
                  <a href="{% url 'allocation-change-detail' change.pk %}" class="inline-flex items-center px-3 py-1.5 bg-primary-600 text-white text-sm rounded-md hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500 transition-colors duration-200">
                    Details
                  </a>
                  </form>
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
{% else %}
  <div class="bg-blue-50 border border-blue-200 rounded-lg p-6 text-center">
    <div class="flex items-center justify-center w-12 h-12 mx-auto mb-4 bg-blue-100 rounded-full">
      <i class="fas fa-info-circle text-blue-600" aria-hidden="true"></i>
    </div>
    <h3 class="text-lg font-medium text-blue-800 mb-2">No Change Requests</h3>
    <p class="text-blue-700">No new or pending allocation change requests!</p>
  </div>
{% endif %}
</div>

<script>
  $("#navbar-main > ul > li.active").removeClass("active");
  $("#navbar-admin").addClass("active");
  $("#navbar-allocation-change-requests").addClass("active");
</script>
{% endblock %}
