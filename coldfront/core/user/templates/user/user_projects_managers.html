{% extends "common/base.html" %}
{% load static %}


{% block title %}
User Projects and Managers{% if not user == viewed_user %}: {{ viewed_user.username }}{% endif %}
{% endblock %}


{% block content %}
<div class="max-w-7xl mx-auto">
  <!-- Page Title -->
  <div class="mb-8">
    <h1 class="text-3xl font-bold text-primary-950">User Projects and Managers{% if not user == viewed_user %}: {{ viewed_user.username }}{% endif %}</h1>
    <div class="mt-2 h-1 w-16 bg-secondary-500 rounded"></div>
  </div>

  {% with object_list as user_project_associations %}
    {% if not user_project_associations %}
      <div class="bg-blue-50 border border-blue-200 rounded-lg p-4" role="alert">
        <div class="flex">
          <div class="flex-shrink-0">
            <i class="fas fa-info-circle text-blue-400" aria-hidden="true"></i>
          </div>
          <div class="ml-3">
            <p class="text-sm text-blue-700">{{ user_pronounish }} {{user_verbform_be}} not part of any projects.</p>
          </div>
        </div>
      </div>
    {% else %}
      {% for association in user_project_associations %}
        {% with association.project as project %}
          <div class="bg-white border border-gray-200 rounded-lg shadow-sm mb-6">
            <!-- Start Project Heading -->
            <div class="px-6 py-4 border-b border-gray-200">
              <div class="flex items-center justify-between">
                <h3 class="text-lg font-semibold text-gray-900">{{ project.title }}</h3>
                {% if user == viewed_user or perms.project.can_view_all_projects %}
                  <a href="{% url 'project-detail' project.pk %}" class="text-primary-600 hover:text-primary-900 transition-colors duration-200" role="button">
                    <i class="far fa-folder-open" aria-hidden="true"></i>
                    <span class="sr-only">Details</span>
                  </a>
                {% endif %}
              </div>
            </div>
            <div class="p-6 space-y-4">
              {# support non-default roles #}
              {% if not association.is_project_manager and not association.role.name == 'User' %}
                <p class="text-gray-700">User role in project: {{ association.role }}</p>
              {% endif %}
              {# a few Pending statuses may be displayed here #}
              <p class="text-gray-700">User status in project:
                {% if association.status.name == 'Active' %}
                  <span class="text-green-600 font-medium">{{ association.status.name }}</span>
                {% else %}
                  <span class="text-gray-600">{{ association.status.name }}</span>
                {% endif %}
              </p>
              <p class="text-gray-700"><strong>Description: </strong>{{ project.description }}</p>
              <p class="text-gray-700"><strong>Field of Science: </strong>{{ project.field_of_science }}</p>
              <p class="text-gray-700"><strong>Project Status: </strong>{{ project.status }}</p>
              <p class="text-gray-700"><strong>Principal Investigator: </strong>{{ project.pi.first_name }} {{ project.pi.last_name }} ({{ project.pi.username }})
                <a href="mailto:{{ project.pi.email }}" class="ml-2 text-primary-600 hover:text-primary-900 transition-colors duration-200">
                  <i class="far fa-envelope" aria-hidden="true"></i>
                  <span class="sr-only">Email</span>
                </a>
                {% if association.is_project_pi %}
                  <span class="text-green-600 font-medium">({{ user_pronounish | lower }} <em>{{user_verbform_be}}</em> the project PI)</span>
                {% endif %}
              </p>
              <!-- End Project Heading -->
              {# card within a card #}
              <!-- Start Project Managers -->
              <div class="bg-gray-50 border border-gray-200 rounded-lg">
                <div class="px-4 py-3 border-b border-gray-200">
                  <div class="flex items-center justify-between">
                    <h4 class="text-base font-medium text-gray-900 flex items-center">
                      <i class="fas fa-users text-primary-600 mr-2" aria-hidden="true"></i> 
                      Additional Managers
                    </h4>
                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800">
                      {{ project.project_managers | length }}
                    </span>
                  </div>
                  {% if association.is_project_manager and not association.is_project_pi %}
                    <p class="text-green-600 font-medium text-sm mt-2">{{ user_pronounish }} {{user_verbform_be}} a manager of this project.</p>
                  {% endif %}
                </div>
                <div class="p-4">
                  {% if project.project_managers %}
                    <div class="overflow-x-auto">
                      <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                          <tr>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Username</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Email</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                          </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                          {% for user in project.project_managers %}
                            <tr class="hover:bg-gray-50">
                              <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">{{ user.user.username }}</td>
                              <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ user.user.first_name }} {{ user.user.last_name }}</td>
                              <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                {{ user.user.email }}
                                <a href="mailto:{{ user.user.email }}" class="ml-2 text-primary-600 hover:text-primary-900">
                                  <i class="far fa-envelope"></i>
                                </a>
                              </td>
                              {% if user.status.name == 'Active' %}
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-green-600 font-medium">{{ user.status.name }}</td>
                              {% else %}
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-blue-600">{{ user.status.name }}</td>
                              {% endif %}
                            </tr>
                          {% endfor %}
                        </tbody>
                      </table>
                    </div>
                  {% else %}
                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4" role="alert">
                      <div class="flex">
                        <div class="flex-shrink-0">
                          <i class="fas fa-info-circle text-blue-400" aria-hidden="true"></i>
                        </div>
                        <div class="ml-3">
                          <p class="text-sm text-blue-700">There are no additional project managers.</p>
                        </div>
                      </div>
                    </div>
                  {% endif %}
                </div>
              </div>
              <!-- End Project Managers -->
            </div>
          </div>
        {% endwith %}
      {% endfor %}
    {% endif %}
  {% endwith %}

  <div class="mt-8">
    <a class="inline-flex items-center px-4 py-2 bg-primary-600 text-white rounded-lg hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500 transition-colors duration-200" href="{% url 'user-profile' viewed_user %}" role="button">
      <i class="fas fa-arrow-left mr-2" aria-hidden="true"></i> Back to user profile
    </a>
  </div>
</div>
{% endblock %}
